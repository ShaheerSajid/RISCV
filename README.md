# 32 bit RISCV Implementation for FPGAs

This is a soft implementation of a processor on the opensource RISC-V ISA. The project was created on Intel Quartus Prime software and tested on DE10 lite.

![enter image description here](https://raw.githubusercontent.com/ShaheerSajid/RISCV/master/images/RISCV.png)

The processor features a single issue, in-order 5-stage pipeline. It currently supports integer, multiply(without div and rem) and single precision IEEE compliant floating point(without float-div) instruction sets. Instructions are fetched at a latency of 1 clock cycle. There is a separate ALU for branch and jump address calculation located in the decode stage. Since the branch addresses are calculated in the decode stage, a single cycle bubble is inserted when the branch is taken. 
To prevent data hazards, port forwarding is done in the decode stage. The second port forwarding is done in the execution stage where data from data memory is forwarded. This removes the stall needed by instructions that immediately follow load instruction, however since branch is calculated in the decode stage, only then the pipelined is stalled for a single cycle so that the data from load instruction is available 
 - Logic Utilization (Core only):
	- Logic Cells: 4366
	- Logic Registers: 802
	 - Memory Bits: 4096

## Benchmarks and Tests

 - Fmax: 20Mhz
	- Current CPU frequency is 16Mhz
 - Calculation of 100 PI digits:
	 - 3141592653589793238462643383279502884197169399375105820974944592307816406286208998628034825342117067
	 - Cycles: 1728973
 - Dhrystone
  ![enter image description here](https://raw.githubusercontent.com/ShaheerSajid/RISCV/master/images/dhry.png)
	 - DMIPS/Mhz : 1.13

	

## Project

```
.
+-- _images
+-- _DE10 Lite
|	+--RISCV_CORE (Quartus Prime lite 18.1 project)
+-- _Code (vscode workspace)
+-- _tests 
|	+--Dhrystone (vscode workspace)
+-- _IPs (Platform Designer)
|	+--Core
|	+--gpio
|	+--timer
|	+--serial
```
Steps to compile project:

 1. Download and install Quartus Prime Lite 18.1
 2. Open RISCV_CORE.qpf in DE10 Lite/RISCV_CORE
 3. Change device and pin assignments according to whatever device you are using
 4. Open tools/platform designer and edit system-on-chip ram IP. Give path of hex file generated by the compiler (See Programming section)
 6. Save and generate
 7. Compile Quartus project
 8. You only need to compile once after which just update memory initialization file and program device again.

## Programming

 1. Download riscv32 from the repository and extract in 'opt' folder. The directory should be as follows: opt/riscv32/bin.
 2. Download visual studio code and open the DE10 workspace in Code folder.
 3. Open link.riscv.ld and give absolute path of the file link.common.ld in the include section.
 4. Add your code to main.c.
 5. Click terminal/run build task.
 6. The file main.hex will be generated inside the flash folder.
 
 ### Libraries
	**GPIO:**
	void  gpio_mode(int, int); //pin(0-31), mode(input,output)
	void  gpio_write(int, int);//pin(0-31),HIGH,LOW
	int  gpio_read(int);//pin(0-31)
	**SERIAL:**
	int  serial_putc(int);//print char
	void  serial_puts(char*);//print string
	char  serial_getc();//get char
	int  serial_available();//if recv
	**TIMER:**
	void  timer_set_prescaler(int);//configure timer clock
	void  timer_set_compare(int);//enter compare value
	int  timer_read_conf();//read configuration register (OVF,CMPF,PRESCALER)
	int  timer_read_cnt();//read timer counter
	**UTIL:**
	printf ported to UART (Does not support floating yet)
	delay function
	**LCD:**
	1602 LCD  interfaced with GPIOs

## Examples

 - LCD
 - UART
 - TIMER


## ToDos

 - [ ] ISP
 - [ ] Interrupts
 - [ ] CSR 
 - [ ] Pipelined Div and Rem
 - [ ] Pipelined FPU
 - [ ] Branch Prediction
 - [ ] Improve FMAX
 - [ ] Support for external flash
 - [ ] Support for SDRAM

<!--stackedit_data:
eyJoaXN0b3J5IjpbMTA2NDc4Nzg5NCw2MzA5NjgyNTcsMTAyNz
IxMjk3MSwtMjAwNjYxMDAzMiwzMjg0NTg3NTIsLTE3NTQzNjg1
MjksLTE0MTg5NDM1MSw0NDMyODM2MDQsNDU1MTU1NTIyXX0=
-->